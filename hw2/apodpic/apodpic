#!/bin/bash

# Validate if input string is a legal MMDD format (e.g., 0131, 1225)
is_legal_mmdd(){
	local mmdd="$1"
	# Check if input is exactly 4 digits
	[[ "$mmdd" =~ ^[0-9]{4}$ ]] || return 1

	local yyyy mm dd norm
	yyyy="$(date +%Y)"
	mm="${mmdd:0:2}"
	dd="${mmdd:2:2}"

	# Verify if the date is valid by normalizing it
	norm="$(date -d "${yyyy}-${mm}-${dd}" +%m%d 2>/dev/null)" || return 1
	[[ "$norm" == "$mmdd" ]]
}

# Construct APOD (Astronomy Picture of the Day) page URL for given MMDD
apod_page_url(){
	local mmdd="$1"
	local yy
	yy="$(date +%y)"
	echo "https://apod.nasa.gov/apod/ap${yy}${mmdd}.html"
}

# Extract image URL from APOD page HTML
extract_image_url(){
	local page_url="$1"
	local html img

	html="$(curl -sL "$page_url")"

	# Try to find image URL in src attribute first, then href attribute
	img="$(echo "$html" | grep -Eoi 'src="image/[^"]+\.(jpg|jpeg|png|gif)"'| head -n1 | cut -d '"' -f2 )"
	if [[ -z "$img" ]]; then
    	img="$(echo "$html" | grep -Eoi 'href="image/[^"]+\.(jpg|jpeg|png|gif)"' | head -n1 | cut -d'"' -f2)"
  	fi

  	[[ -n "$img" ]] || return 1
  	echo "https://apod.nasa.gov/apod/$img"
}

# Get image file size in kilobytes from HTTP header
image_size_kb(){
	local url="$1"
	local bytes
<<<<<<< HEAD
	bytes="$(curl -sI "$url" | awk -F': ' 'tolower($1)=="content-length"{print $2}' | tr -d '\r')"
=======
	# Extract Content-Length from HTTP headers
	bytes="$(curl -sI ${url} | awk -F': ' 'tolower($1)=="content-length"{print $2}' | tr -d ''
)"
>>>>>>> 5c81817ce3b722021ef73ccde4a116d6855efefa

	[[ -n "$bytes" ]] || return 1

	# Convert bytes to kilobytes with one decimal place
	awk -v b="$bytes" 'BEGIN{printf "%.1f kB", b/1000}'
}


# Main script: process each MMDD argument
today="$(date +%m%d)"
for mmdd in "$@" ; do
	# Validate date format
	if  ! is_legal_mmdd "$mmdd"  ; then
		echo "$mmdd not a legal MMDD"
		continue
	fi

	# Check if date is in the future
	if (( 10#$mmdd > 10#$today )) ; then 
		echo "$mmdd is a day not reached yet"
		continue
	fi
	page="$(apod_page_url "$mmdd")"

	# Check if page exists (HTTP 200)
	code="$(curl -s -o /dev/null -w "%{http_code}" -L "$page")"
	if [[ "$code" != "200" ]]; then
  		echo "$mmdd a day not reached yet"
  		continue
	fi
	# Extract image URL from the page
	imgurl="$(extract_image_url "$page")" || {
  		echo "$mmdd no picture found"
  		continue
	}

	# Get filename and size, then display results
	fname="$(basename "$imgurl")"
	image_size="$(image_size_kb "${imgurl}")"
	echo "$mmdd $fname, $image_size"

done


